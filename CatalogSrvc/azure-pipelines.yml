trigger:
  batch: true
  paths:
    include:
    - CatalogSrvc/*

steps:
- task: Gradle@2
  displayName: 'gradlew build'
  inputs:
    gradleWrapperFile: '$(Parameters.wrapperScript)'
    workingDirectory: CatalogSrvc
    tasks: '$(Parameters.tasks)'

- task: CopyFiles@2
  displayName: 'Copy Files to: $(build.artifactstagingdirectory)'
  inputs:
    SourceFolder: '$(system.defaultworkingdirectory)'
    Contents: '**/*.jar'
    TargetFolder: '$(build.artifactstagingdirectory)'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'
  inputs:
    PathtoPublish: '$(build.artifactstagingdirectory)'

- task: Docker@1
  displayName: 'Docker build'
  inputs:
    dockerFile: CatalogSrvc/Dockerfile
    useDefaultContext: false
    buildContext: CatalogSrvc
    imageName: '$(ACR_SERVER)/PUMRP-micro/catalog-service:$(Build.BuildId)'
    includeLatestTag: true
- task: Docker@1
  displayName: 'Login to ACR'
  inputs:
    azureSubscriptionEndpoint: $(SERVICE_CONNECTION)
    azureContainerRegistry: $(ACR_SERVER)
    command: login
- task: Docker@1
  displayName: 'Docker push to ACR'
  inputs:
    command: 'push'
    imageName: '$(ACR_SERVER)/PUMRP-micro/catalog-service:$(Build.BuildId)'
    includeLatestTag: true